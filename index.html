<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GST Leave Management</title>
    <style>
      body {
        margin: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        display: flex;
        height: 100vh;
        color: #333;
      }
      .sidebar {
        width: 250px;
        background-color: #1e293b;
        color: white;
        display: flex;
        flex-direction: column;
        padding: 20px;
      }
      .user-profile {
        text-align: center;
        margin-bottom: 30px;
      }
      .user-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background-color: #475569;
        margin: 0 auto 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: bold;
        color: white;
      }
      .user-email {
        font-size: 14px;
        color: #cbd5e1;
        word-break: break-word;
      }
      .menu {
        list-style: none;
        padding: 0;
      }
      .menu li {
        padding: 12px 15px;
        cursor: pointer;
        border-radius: 8px;
        margin-bottom: 10px;
      }
      .menu li:hover,
      .menu li.active {
        background-color: #334155;
      }
      .main {
        flex: 1;
        padding: 30px;
        background-color: #f8fafc;
        overflow-y: auto;
      }
      .cards {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
      }
      .card {
        flex: 1;
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        text-align: center;
      }
      .card h2 {
        margin: 0;
        font-size: 2rem;
      }
      .card p {
        color: #64748b;
        margin-top: 5px;
      }
      .leave-history,
      .team-requests {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      th,
      td {
        text-align: left;
        padding: 12px;
        border-bottom: 1px solid #e2e8f0;
      }
      .form-section {
        background: white;
        border-radius: 12px;
        padding: 20px;
        max-width: 500px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
      }
      .form-group input {
        width: 100%;
        padding: 10px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
      }
      .form-group input[type='number'] {
        width: 120px;
      }
      button {
        background-color: #1d4ed8;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
      }
      button:hover {
        background-color: #2563eb;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <div class="user-profile">
        <div class="user-icon" id="user-icon"><span id="user-initials"></span></div>
        <div class="user-email" id="user-email">Loading...</div>
      </div>
      <ul class="menu">
        <li class="active" onclick="showView('dashboard')">Your Dashboard</li>
        <li onclick="showView('new-request')">New Request</li>
        <li onclick="showView('your-team')">Your Team</li>
      </ul>
    </div>

    <div class="main">
      <!-- Dashboard View -->
      <div id="dashboard-view">
        <div class="cards">
          <div class="card">
            <h2 id="compOffs">0</h2>
            <p>Comp-Offs Available</p>
          </div>
          <div class="card">
            <h2 id="totalLeaves">0</h2>
            <p>Total Leaves Taken</p>
            <h6>(Last <span id="lookBackPeriod">XX</span> days)</h6>
          </div>
        </div>
        <div class="leave-history">
          <h3>Your Leave History</h3>
          <table>
            <thead>
              <tr>
                <th>Request ID</th>
                <th>From</th>
                <th>To</th>
                <th>Reason</th>
                <th>Comp off used</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="historyBody"></tbody>
          </table>
        </div>
      </div>

      <!-- New Request View -->
      <div id="new-request-view" style="display: none;">
        <div class="form-section">
          <h3>Apply for Leave</h3>
          <div class="form-group">
            <label for="from-date">From Date</label>
            <input type="date" id="from-date" />
          </div>

          <div class="form-group">
            <label for="to-date">To Date</label>
            <input type="date" id="to-date" disabled />
          </div>

          <div class="form-group">
            <p >Number of days: <span id="no-of-days"></p>
          </div>

          <div class="form-group">
            <label for="reason">Reason</label>
            <input type="text" id="reason" />
          </div>

          <div class="form-group">
            <label for="comp-off">Comp-Offs to Use</label>
            <input type="number" id="comp-off" min="0" max="availableCompOffs" />
            <p>Available: <span id="comp-off-available-count"></p>
          </div>
          <button id="submit-request-btn" onclick="submitRequest()">Submit Request</button>
        </div>
      </div>

      <!-- Your Team View -->
      <div id="your-team-view" style="display: none;">
        <div class="team-requests">
          <h3>Team Leave Requests</h3>
          <table>
            <thead>
              <tr>
                <th>Request ID</th>
                <th>Email</th>
                <th>From</th>
                <th>To</th>
                <th>Reason</th>
                <th>Comp off used</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="teamRequestsBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      let userEmail = "";
      let availableCompOffs = 0;
      let newRequestFromDate = "";
      let newRequestToDate = "";
      let newRequestNumberOfDays = 0;

      document.getElementById("from-date").addEventListener("change", function () {
        newRequestFromDate = this.value; 
        console.log("selected from date ", newRequestFromDate);
        const toDateInput = document.getElementById("to-date");

        if (newRequestFromDate) {
          toDateInput.disabled = false;
          toDateInput.min = newRequestFromDate;
          // Optional: Clear old value if it's before fromDate
          if (toDateInput.value && toDateInput.value < newRequestFromDate) {
            toDateInput.value = "";
          }
        } else {
          toDateInput.disabled = true;
          toDateInput.value = "";
        }
      });
      document.getElementById("to-date").addEventListener("change", function () {
        newRequestToDate = this.value;
        console.log("selected to date ", newRequestToDate);
        google.script.run
        .withSuccessHandler(function(daysCount) {
          newRequestNumberOfDays = daysCount
          document.getElementById("no-of-days").textContent = newRequestNumberOfDays;

        }).calculateLeaveDays(newRequestFromDate, newRequestToDate); //YYYY-MM-DD
      });


      function getInitials(email) {
        console.log(`getting initials for email ${email}`)
        if (!email) return '';
        const name = email.split('@')[0];
        const parts = name.replace(/\d+/g, '').split(/[._-]/); // handles first.last, first_last, etc.
        const initials = parts.slice(0, 2).map(p => p.charAt(0).toUpperCase()).join('');
        return initials || name.charAt(0).toUpperCase();
      }

      function getColorFromInitials(initials) {
        console.log(`getting color for ${initials}`)
        const colors = ['#1abc9c', '#3498db', '#e67e22', '#9b59b6', '#f39c12', '#e74c3c', '#2ecc71'];
        let hash = 0;
        for (let i = 0; i < initials.length; i++) {
          hash += initials.charCodeAt(i);
        }
        return colors[hash % colors.length];
      }

      // Fetch user email from server and invoke loadDashboard
      google.script.run
        .withSuccessHandler(function(email) {
          console.log(`successfully fetched email ${email}`)
          userEmail = email;
          document.getElementById("user-email").textContent = email;
          const initials = getInitials(email);
          document.getElementById("user-initials").textContent = initials;
          document.getElementById("user-icon").style.backgroundColor = getColorFromInitials(initials);
          loadDashboard();
        }).getUserEmail();


      function loadDashboard() {
        console.log(`Will load dashboard data for user ${userEmail}`)
        google.script.run.withSuccessHandler(renderDashboard).getDashboardData(userEmail);
      }

      function renderDashboard(data) {
        console.log("data", data)
        availableCompOffs = data.compOffs;
        document.getElementById("compOffs").textContent = availableCompOffs
        document.getElementById("totalLeaves").textContent = data.approvedLeavesCount;
        document.getElementById("lookBackPeriod").textContent = data.lookBackPeriod;
        const tbody = document.getElementById("historyBody");
        tbody.innerHTML = "";
        data.leavesHistory.forEach(item => {
          console.log("Leave item: ", item)
          const tr = document.createElement("tr");
          let cancelButtonHTML = "";
          if (item.Status === "Pending") {
            cancelButtonHTML = `<button onclick="cancelLeaveRequest('${item.Request_Id}')">Cancel</button>`;
          }
          tr.innerHTML = `<td>${item.Request_Id}<td>${item.From}</td><td>${item.To}</td><td>${item.Reason}</td><td>${item.Comp_off}</td><td>${item.Status}</td><td>${cancelButtonHTML}</td>`;
          tbody.appendChild(tr);
        });
      }

      function setAvailableCompOffs(availableCompOffs) {
        const input = document.getElementById("comp-off");
        const label = document.getElementById("comp-off-available-count");

        input.max = availableCompOffs;
        label.textContent = availableCompOffs;
      }
      const form = document.getElementById("leave-request-form");
      const submitBtn = document.getElementById("submit-request-btn");

      function submitRequest() {
        const fromDateStr = document.getElementById("from-date").value;
        const toDateStr = document.getElementById("to-date").value;
        const compOffs = parseInt(document.getElementById("comp-off").value || "0", 10);
        const reason = document.getElementById("reason").value.trim();
        
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const fromDate = new Date(fromDateStr);
        const toDate = new Date(toDateStr);
        console.log("validating the form")

        // Validation 1: Email is valid
        if (!emailPattern.test(userEmail)) {
          alert("Invalid email address.");
          return;
        }

        // Validation 2: From Date should be before or equal to To Date
        if (!fromDateStr || !toDateStr || fromDate > toDate) {
          alert("From Date must be before or same as To Date.");
          return;
        }

        // Validation 3: Reason should not be empty
        if (!reason) {
          alert("Please enter a reason for the leave.");
          return;
        }

        // Validation 4: Comp-off <= number of leave days (excluding weekends/holidays if applicable)
        if (compOffs > newRequestNumberOfDays) {
          alert(`Comp-off used (${compOffs}) cannot exceed total leave days (${newRequestNumberOfDays}).`);
          return;
        }

        // All validations passed, submit
        const formData = {
          email: userEmail,
          fromDate: fromDateStr,
          toDate: toDateStr,
          reason: reason,
          days: newRequestNumberOfDays,
          compOffs: compOffs,
        };

        google.script.run.withSuccessHandler(() => {
          alert("Request submitted successfully.");
          showView("dashboard");
          loadDashboard();
        }).submitLeaveRequest(formData);
      }
      function cancelLeaveRequest(requestId) {
        if (!confirm("Are you sure you want to cancel this leave request?")) return;

        google.script.run.withSuccessHandler(() => {
          alert("Leave request canceled.");
          loadDashboard(); // Refresh data
        }).cancelLeaveRequestByUser(userEmail, requestId);
      }


      function showView(viewId) {
        document.querySelectorAll(".main > div").forEach(div => (div.style.display = "none"));
        document.getElementById(viewId + "-view").style.display = "block";

        document.querySelectorAll(".menu li").forEach(li => li.classList.remove("active"));
        const index = { dashboard: 0, "new-request": 1, "your-team": 2 }[viewId];
        document.querySelectorAll(".menu li")[index].classList.add("active");

        if (viewId === "your-team") {
          console.log("Fetching team's leave requests for TL: ", userEmail);
          google.script.run.withSuccessHandler(renderTeamRequests).getTeamRequests(userEmail);
        }
        if(viewId === "new-request"){
          setAvailableCompOffs(availableCompOffs)
        }
      }

      function renderTeamRequests(data) {
        console.log("Received team's leave requests ", data)

        const tbody = document.getElementById("teamRequestsBody");
        tbody.innerHTML = "";
        
        data.forEach(item => {
          const tr = document.createElement("tr");
          let approveButtonHTML = "";
          let rejectButtonHTML = "";
          let checkRecommendationButtonHTML = "";
          if (item.Status === "Pending") {
            approveButtonHTML = `<button onclick="approveLeaveRequest('${item.Request_Id}', '${item.Email}')">Approve</button>`;
            rejectButtonHTML = `<button onclick="rejectLeaveRequest('${item.Request_Id}', '${item.Email}')">Reject</button>`;
            checkRecommendationButtonHTML = `<button onclick="checkRecommendationLeaveRequest('${item.Request_Id}', '${item.Email}')">Check recommendation</button>`;
          }
          tr.innerHTML = `<td>${item.Request_Id}</td><td>${item.Email}</td><td>${item.From}</td><td>${item.To}</td><td>${item.Reason}</td><td>${item.Comp_off}</td><td>${item.Status}</td><td>${checkRecommendationButtonHTML}</td><td>${approveButtonHTML}</td><td>${rejectButtonHTML}</td>`;
          tbody.appendChild(tr);
        });
      }

      function approveLeaveRequest(requestId, memberEmail) {
        if (!confirm("Are you sure you want to cancel this leave request?")) return;

        google.script.run.withSuccessHandler(() => {
          alert("Leave request canceled.");
          loadDashboard(); // Refresh data
        }).approveLeaveRequest(memberEmail, requestId);
      }

      function rejectLeaveRequest(requestId, memberEmail) {
        if (!confirm("Are you sure you want to cancel this leave request?")) return;

        google.script.run.withSuccessHandler(() => {
          alert("Leave request canceled.");
          loadDashboard(); // Refresh data
        }).rejectLeaveRequest(memberEmail, requestId);
      }

      function checkRecommendationLeaveRequest(requestId, memberEmail) {
        showLoader("Checking recommendation...");
        google.script.run.withSuccessHandler((recomm) => {
          hideLoader();
          console.log("Recommendation: ", recomm)
          if(recomm.success){
            showRecommendationModal(recomm.message)
          }else{
            alert("Error: " + (recomm.error || "Unable to fetch recommendation."));
          }
          
        })
        .withFailureHandler(err => {
          hideLoader();
          console.error(err);
        })
        .getLeaveRecommendation(requestId);
      }

      function showRecommendationModal(data) {
        document.getElementById("recommendationOverall").textContent = data.summary.overall;
        document.getElementById("recommendationNote").textContent = data.summary.note;

        const tbody = document.getElementById("recommendationBreakdownBody");
        tbody.innerHTML = "";

        data.breakdown.forEach(day => {
          const tr = document.createElement("tr");
          const isApproved = day.recommendation === "Approved";
          tr.style.backgroundColor = isApproved ? "#dcfce7" : "#fee2e2";  // green / red
          tr.style.color = "#111";

          tr.innerHTML = `
            <td style="padding:8px; border: 1px solid #ccc;">${day.date}</td>
            <td style="padding:8px; border: 1px solid #ccc;">${day.dayType}</td>
            <td style="padding:8px; border: 1px solid #ccc;">${day.availableStaff}/${day.totalStaff}</td>
            <td style="padding:8px; border: 1px solid #ccc;">${day.recommendation}</td>
            <td style="padding:8px; border: 1px solid #ccc;">${day.reason}</td>
          `;
          tbody.appendChild(tr);
        });

        document.getElementById("recommendationModal").style.display = "flex";
      }

      function hideRecommendationModal() {
        document.getElementById("recommendationModal").style.display = "none";
      }


      function showLoader(message = "Loading...") {
        document.getElementById("loaderText").textContent = message;
        document.getElementById("loaderModal").style.display = "flex";
      }

      function hideLoader(delay = 300) {
        setTimeout(() => {
          document.getElementById("loaderModal").style.display = "none";
        }, delay);
      }
    </script>
    <!-- Recommendation Modal -->
    <div id="recommendationModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.4); z-index:9999; align-items:center; justify-content:center;">
      <div style="background:white; padding:30px; border-radius:12px; width:90%; max-width:600px; box-shadow:0 4px 12px rgba(0,0,0,0.2); position:relative;">
        <span onclick="hideRecommendationModal()" style="position:absolute; top:10px; right:15px; font-size:18px; cursor:pointer;">&times;</span>
        <h3 style="margin-top:0;">Leave Recommendation Summary</h3>
        <p><strong>Overall:</strong> <span id="recommendationOverall"></span></p>
        <p><strong>Note:</strong> <span id="recommendationNote"></span></p>
        <table style="width:100%; border-collapse: collapse; margin-top: 20px;">
          <thead>
            <tr style="background:#f1f5f9;">
              <th style="padding:8px; border: 1px solid #ccc;">Date</th>
              <th style="padding:8px; border: 1px solid #ccc;">Day Type</th>
              <th style="padding:8px; border: 1px solid #ccc;">Availability</th>
              <th style="padding:8px; border: 1px solid #ccc;">Recommendation</th>
              <th style="padding:8px; border: 1px solid #ccc;">Reason</th>
            </tr>
          </thead>
          <tbody id="recommendationBreakdownBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Modal Loader -->
    <div id="loaderModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.4); z-index:9999; align-items:center; justify-content:center;">
      <div style="background:white; padding:30px 40px; border-radius:12px; text-align:center; box-shadow:0 4px 8px rgba(0,0,0,0.2);">
        <div class="spinner" style="margin: auto; width: 40px; height: 40px; border: 5px solid #e2e8f0; border-top: 5px solid #1d4ed8; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <p id="loaderText" style="margin-top: 16px; font-weight: 500;">Loading...</p>
      </div>
    </div>

    <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    </style>
  </body>
</html>
